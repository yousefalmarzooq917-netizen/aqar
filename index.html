<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙƒØªØ¨ Ø­ÙŠ Ø§Ù„ÙØªØ­ Ù„Ù„Ø¹Ù‚Ø§Ø± - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #113f28; --secondary: #d4af37; --bg: #f4f6f9; --card-bg: #ffffff;
            --text: #333; --border: #ccc; --shadow: rgba(0,0,0,0.15);
        }
        [data-theme="dark"] {
            --primary: #1a5c3a; --secondary: #f1c40f; --bg: #121212; --card-bg: #1e1e1e;
            --text: #e0e0e0; --border: #444; --shadow: rgba(0,0,0,0.5);
        }
        body { font-family: 'Almarai', sans-serif; margin: 0; background-color: var(--bg); color: var(--text); transition: 0.3s; padding-bottom: 50px; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { background: linear-gradient(135deg, var(--primary), #0a291a); color: white; padding: 40px 20px; position: relative; text-align: center; border-bottom: 5px solid var(--secondary); }
        .logo { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--secondary); object-fit: cover; background: white; margin-bottom: 15px; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
        .top-nav { position: absolute; top: 15px; left: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-family: 'Almarai'; font-size: 14px; font-weight: bold; }
        .nav-btn:hover { background: var(--secondary); color: black; }

        .container { width: 95%; max-width: 1250px; margin: 25px auto; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        #adminPanel { display: none; background: var(--card-bg); border: 3px solid var(--primary); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px var(--shadow); }
        #adminPanel h2 { font-size: 28px; color: var(--primary); margin-top: 0; border-bottom: 2px solid var(--secondary); padding-bottom: 10px; }
        .admin-form-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .admin-input { padding: 18px; font-size: 18px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Almarai'; background: var(--bg); color: var(--text); width: 100%; box-sizing: border-box; }
        .admin-input:focus { border-color: var(--secondary); outline: none; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px; color: var(--primary); }
        .btn-save { background: var(--primary); color: white; padding: 20px; border-radius: 12px; border: none; font-size: 20px; font-weight: 800; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn-save:hover { background: #0a291a; transform: scale(1.01); }

        /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-item { background: var(--primary); color: white; padding: 20px; border-radius: 15px; text-align: center; }
        .stat-item span { display: block; font-size: 30px; font-weight: 800; color: var(--secondary); }

        /* Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¨Ø­Ø« */
        .toolbar { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; align-items: center; }
        .search-bar { flex: 1; padding: 18px; border-radius: 15px; border: 2px solid var(--border); font-size: 18px; font-family: 'Almarai'; background: var(--card-bg); color: var(--text); }
        .filter-select { padding: 18px; border-radius: 15px; border: 2px solid var(--border); font-size: 16px; font-family: 'Almarai'; background: var(--card-bg); color: var(--text); }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø±Ø¶ */
        .prop-grid { display: grid; gap: 25px; transition: 0.3s; }
        .grid-view { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
        .list-view { grid-template-columns: 1fr; }

        .prop-card { background: var(--card-bg); border-radius: 20px; overflow: hidden; box-shadow: 0 8px 20px var(--shadow); border: 1px solid var(--border); position: relative; }
        .prop-img { width: 100%; height: 230px; object-fit: cover; pointer-events: none; } /* Ø­Ù…Ø§ÙŠØ© Ù…Ø¨Ø¯Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ø¶ØºØ· */
        .status-tag { position: absolute; top: 15px; right: 15px; padding: 7px 15px; border-radius: 25px; color: white; font-weight: bold; font-size: 14px; z-index: 10; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .tag-avail { background: #27ae60; } .tag-sold { background: #c0392b; } .tag-arch { background: #7f8c8d; }
        .views-tag { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; z-index: 10; display: flex; align-items: center; gap: 5px; }

        .prop-details { padding: 20px; }
        .price-text { font-size: 24px; font-weight: 800; color: var(--primary); margin: 10px 0; }
        [data-theme="dark"] .price-text { color: var(--secondary); }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Skeleton) */
        .skeleton { background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%); background-size: 200% 100%; animation: loadingAnim 1.5s infinite; border-radius: 10px; }
        [data-theme="dark"] .skeleton { background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%); }
        @keyframes loadingAnim { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginModal { display:none; position:fixed; z-index:5000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; }
        .login-box { background:var(--card-bg); padding:40px; border-radius:20px; width:90%; max-width:400px; text-align:center; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-action { padding: 12px; border-radius: 10px; border: none; font-family: 'Almarai'; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; flex: 1; display:flex; justify-content:center; align-items:center; gap:5px; }
        .btn-main { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        [data-theme="dark"] .btn-outline { border-color: var(--secondary); color: var(--secondary); }
        
        .backup-section { margin-top: 40px; padding-top: 20px; border-top: 2px solid var(--border); text-align: center; }
    </style>
</head>
<body data-theme="light" oncontextmenu="return false;"> <div id="loginModal">
        <div class="login-box">
            <h2 style="color:var(--primary)">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
            <input type="text" id="userInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="admin-input" style="margin-bottom:15px">
            <input type="password" id="passInput" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ" class="admin-input" style="margin-bottom:20px">
            <button class="btn-save" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
            <button class="btn-action" onclick="closeLogin()" style="margin-top:10px; background:#666; color:white;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <header>
        <div class="top-nav">
            <button class="nav-btn" onclick="toggleTheme()">ğŸŒ™ Ù„ÙŠÙ„ÙŠ</button>
            <button class="nav-btn" onclick="setView('grid')">â¬œ ÙƒØ±ÙˆØª</button>
            <button class="nav-btn" onclick="setView('list')">â˜° Ù‚Ø§Ø¦Ù…Ø©</button>
            <button class="nav-btn" onclick="window.open('https://maps.app.goo.gl/CYkchicmZwX2o9fe9')">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…ÙƒØªØ¨Ù†Ø§</button>
            <button class="nav-btn" style="background:var(--secondary); color:black;" onclick="showLogin()" id="adminBtn">ğŸ‘¤ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        </div>
        <img src="https://c.top4top.io/p_37048y9xn1.jpg" class="logo" alt="Logo">
        <h1 style="margin:0; font-size:32px;">Ø­ÙŠ Ø§Ù„ÙØªØ­ Ù„Ù„Ø¹Ù‚Ø§Ø±</h1>
        <p style="margin:10px 0 0; opacity:0.9; font-size:18px;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
    </header>

    <div class="container">
        <div id="adminPanel">
            <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</h2>
            <div class="stats-grid">
                <div class="stat-item">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ<span id="s_total">0</span></div>
                <div class="stat-item">Ø§Ù„Ù…ØªØ§Ø­<span id="s_avail">0</span></div>
                <div class="stat-item">Ø§Ù„Ù…Ø¨Ø§Ø¹<span id="s_sold">0</span></div>
            </div>

            <form id="propForm">
                <input type="hidden" id="editId">
                <div class="admin-form-group">
                    <div><label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±</label><input type="text" id="f_type" class="admin-input" placeholder="ÙÙŠÙ„Ø§ØŒ Ø´Ù‚Ø©.." required></div>
                    <div><label>Ø§Ù„Ø­ÙŠ</label><input type="text" id="f_neigh" class="admin-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­ÙŠ" required></div>
                    <div><label>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</label><input type="text" id="f_area" class="admin-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: 300 Ù…"></div>
                    <div><label>Ø§Ù„Ø³Ø¹Ø± (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)</label><input type="number" id="f_price" class="admin-input" placeholder="1200000" required></div>
                    <div><label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±</label>
                        <select id="f_status" class="admin-input">
                            <option value="Ù…ØªØ§Ø­">Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ø±Ø¶</option>
                            <option value="Ù…Ø¨Ø§Ø¹">Ù…Ø¨Ø§Ø¹</option>
                            <option value="Ù…Ø­Ø¬ÙˆØ²">Ù…Ø­Ø¬ÙˆØ²</option>
                            <option value="Ù…Ø¤Ø±Ø´Ù">Ù…Ø¤Ø±Ø´Ù (Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙ‚Ø·)</option>
                        </select>
                    </div>
                    <div><label>Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (Maps)</label><input type="text" id="f_map" class="admin-input" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
                </div>

                <div class="admin-form-group" style="background:rgba(212,175,55,0.1); padding:15px; border-radius:15px;">
                    <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø³Ø±ÙŠ)</label><input type="text" id="f_owner" class="admin-input"></div>
                    <div><label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø³Ø±ÙŠ)</label><input type="text" id="f_phone" class="admin-input"></div>
                    <div><label>Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± (Ø³ÙŠØªÙ… Ø®ØªÙ…Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</label><input type="file" id="f_imgs" multiple class="admin-input"></div>
                </div>

                <button type="submit" class="btn-save" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ ÙˆÙ†Ø´Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±</button>
                <button type="button" class="btn-action" onclick="cancelEdit()" style="width:100%; margin-top:10px; background:#666; color:white;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            </form>

            <div class="backup-section">
                <p>Ù‚Ø³Ù… Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                <button onclick="exportFullBackup()" style="background:#007bff; color:white; padding:15px 30px; border-radius:10px; border:none; cursor:pointer; font-weight:bold;">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø´Ø§Ù…Ù„Ø© (JSON)</button>
            </div>
        </div>

        <div class="toolbar">
            <input type="text" id="searchBox" class="search-bar" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø­ÙŠ Ø£Ùˆ Ù†ÙˆØ¹..." onkeyup="filterContent()">
            <select id="filterStatus" class="filter-select" onchange="filterContent()">
                <option value="Ø§Ù„ÙƒÙ„">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="Ù…ØªØ§Ø­">Ù…ØªØ§Ø­</option>
                <option value="Ù…Ø¨Ø§Ø¹">Ù…Ø¨Ø§Ø¹</option>
                <option value="Ù…Ø­Ø¬ÙˆØ²">Ù…Ø­Ø¬ÙˆØ²</option>
            </select>
        </div>

        <div id="mainGrid" class="prop-grid grid-view">
            </div>
    </div>

    <div id="detailsModal" style="display:none; position:fixed; z-index:4000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); overflow-y:auto;">
        <div style="background:var(--card-bg); margin:20px auto; width:95%; max-width:800px; border-radius:25px; padding:30px; position:relative;">
            <span onclick="this.parentElement.parentElement.style.display='none'" style="position:absolute; left:20px; top:15px; font-size:40px; cursor:pointer;">Ã—</span>
            <div id="detailsContent"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAbzqda0NFaj3nAotHK9_1exNqNDeRASxk",
            authDomain: "alfateh-aqar.firebaseapp.com",
            projectId: "alfateh-aqar",
            storageBucket: "alfateh-aqar.firebasestorage.app",
            messagingSenderId: "170214550520",
            appId: "1:170214550520:web:638dfbc62ea5edc7cc040d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let isAdmin = false;
        let allData = [];

        function showLogin() { 
            if(isAdmin) { isAdmin=false; location.reload(); }
            else { document.getElementById('loginModal').style.display='flex'; }
        }
        function closeLogin() { document.getElementById('loginModal').style.display='none'; }
        
        function checkLogin() {
            if(document.getElementById('userInput').value === "admin" && document.getElementById('passInput').value === "1234") {
                isAdmin = true;
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminBtn').innerText = "ğŸ‘¤ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…ÙˆØ¸Ù";
                closeLogin();
                renderAll();
            } else { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©!"); }
        }

        function formatMoney(n) { return new Intl.NumberFormat('ar-SA').format(n) + " Ø±ÙŠØ§Ù„"; }
        function setView(v) { document.getElementById('mainGrid').className = 'prop-grid ' + (v==='grid'?'grid-view':'list-view'); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')==='light'?'dark':'light'); }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙƒÙŠÙ„ÙŠØªÙˆÙ† (Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„) Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function showSkeletons() {
            const grid = document.getElementById('mainGrid');
            grid.innerHTML = '';
            for(let i=0; i<6; i++) {
                grid.innerHTML += `
                    <div class="prop-card" style="padding:15px">
                        <div class="skeleton" style="height:200px; margin-bottom:15px"></div>
                        <div class="skeleton" style="height:25px; width:60%; margin-bottom:10px"></div>
                        <div class="skeleton" style="height:20px; width:40%; margin-bottom:15px"></div>
                        <div style="display:flex; gap:10px;"><div class="skeleton" style="height:40px; flex:1"></div><div class="skeleton" style="height:40px; flex:1"></div></div>
                    </div>`;
            }
        }

        async function loadData() {
            showSkeletons();
            const snap = await db.collection('properties').orderBy('timestamp', 'desc').get();
            allData = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            updateStats();
            renderAll();
        }

        function updateStats() {
            document.getElementById('s_total').innerText = allData.length;
            document.getElementById('s_avail').innerText = allData.filter(i => i.status === 'Ù…ØªØ§Ø­').length;
            document.getElementById('s_sold').innerText = allData.filter(i => i.status === 'Ù…Ø¨Ø§Ø¹').length;
        }

        function renderAll(data = allData) {
            const grid = document.getElementById('mainGrid');
            grid.innerHTML = '';
            data.forEach(item => {
                if(item.status === 'Ù…Ø¤Ø±Ø´Ù' && !isAdmin) return;
                
                const statusClass = item.status === 'Ù…ØªØ§Ø­' ? 'tag-avail' : (item.status === 'Ù…Ø¨Ø§Ø¹' ? 'tag-sold' : 'tag-arch');
                const viewsCount = item.views || 0;
                
                const card = document.createElement('div');
                card.className = 'prop-card';
                card.innerHTML = `
                    <div class="views-tag">ğŸ‘ï¸ ${viewsCount}</div>
                    <div class="status-tag ${statusClass}">${item.status}</div>
                    <img src="${(item.imgs && item.imgs[0]) || 'https://via.placeholder.com/400x250'}" class="prop-img">
                    <div class="prop-details">
                        <div style="font-size:14px; opacity:0.7;">ğŸ“ ${item.neigh}</div>
                        <h3 style="margin:5px 0;">${item.type}</h3>
                        <div class="price-text">${formatMoney(item.price)}</div>
                        <div style="font-size:14px; margin-bottom:15px;">ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${item.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-action btn-main" onclick="openDetails('${item.id}')">Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                            <button class="btn-action btn-outline" onclick="shareMe('${item.type}','${item.neigh}')">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
                        </div>
                        ${isAdmin ? `
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid var(--border); display:flex; gap:5px;">
                                <button onclick="editItem('${item.id}')" style="flex:1">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button onclick="deleteItem('${item.id}')" style="flex:1; background:red; color:white; border:none; border-radius:5px;">Ø­Ø°Ù</button>
                            </div>
                        ` : ''}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function openDetails(id) {
            const item = allData.find(i => i.id === id);
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ø§Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…ÙˆØ¸Ù Ù‡Ùˆ Ù…Ù† ÙŠØ´Ø§Ù‡Ø¯)
            if(!isAdmin) {
                await db.collection('properties').doc(id).update({ views: firebase.firestore.FieldValue.increment(1) });
                item.views = (item.views || 0) + 1; // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
                renderAll(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            }

            let imgGallery = '<div style="display:flex; overflow-x:auto; gap:10px; margin-bottom:20px; padding-bottom:10px;">';
            (item.imgs || []).forEach(src => imgGallery += `<img src="${src}" style="height:250px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.2); pointer-events:none;">`);
            imgGallery += '</div>';

            // Ø¹Ø²Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù„Ù† ØªØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù€ HTML Ø§Ù„Ø§ Ù„Ù„Ù…Ø´Ø±Ù)
            let adminSec = '';
            if(isAdmin) {
                adminSec = `<div style="background:#fffde7; padding:20px; border-radius:15px; margin:20px 0; color:black; border:1px dashed #d4af37;">
                    <h4 style="margin:0 0 10px 0;">ğŸ”’ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§ØµØ© (Ù…Ø´ÙØ±Ø©):</h4>
                    <p>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ: ${item.ownerName || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                    <p>Ø§Ù„Ø¬ÙˆØ§Ù„: ${item.ownerPhone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                </div>`;
            }

            document.getElementById('detailsContent').innerHTML = `
                ${imgGallery}
                <h2 style="color:var(--primary)">${item.type} - Ø­ÙŠ ${item.neigh}</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; font-size:18px; border-top:1px solid var(--border); padding-top:20px;">
                    <p><b>Ø§Ù„Ø³Ø¹Ø±:</b> <span style="color:var(--secondary); font-weight:800;">${formatMoney(item.price)}</span></p>
                    <p><b>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</b> ${item.area}</p>
                    <p><b>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª:</b> ${item.views || 0} ğŸ‘ï¸</p>
                    <p><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${item.status}</p>
                </div>
                ${adminSec}
                <div style="display:flex; gap:15px; margin-top:30px;">
                    <a href="https://wa.me/966590002216?text=Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† ${item.type} ÙÙŠ ${item.neigh} Ù…Ø¹Ø±ÙˆØ¶ Ø¨Ø³Ø¹Ø± ${item.price}" target="_blank" style="flex:1; background:#25d366; color:white; text-align:center; padding:20px; border-radius:15px; text-decoration:none; font-weight:bold; font-size:18px;">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>
                    ${item.map ? `<a href="${item.map}" target="_blank" style="flex:1; background:#4285F4; color:white; text-align:center; padding:20px; border-radius:15px; text-decoration:none; font-weight:bold; font-size:18px;">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±</a>` : ''}
                </div>
            `;
            document.getElementById('detailsModal').style.display = 'block';
        }

        // Ø¶ØºØ· ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙˆØ± (Ø¥Ø¶Ø§ÙØ© Watermark)
        async function compressImg(file) {
            return new Promise(res => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = e => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxW = 800;
                        canvas.width = maxW;
                        canvas.height = img.height * (maxW / img.width);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ØªÙ… Ø§Ù„Ù…Ø§Ø¦ÙŠ (Watermark) Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙˆØ±Ø©
                        ctx.fillStyle = "rgba(255, 255, 255, 0.4)"; // Ø´ÙØ§ÙÙŠØ©
                        ctx.font = "bold 40px Almarai";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„ØµÙˆØ±Ø©
                        ctx.fillText("Ù…ÙƒØªØ¨ Ø­ÙŠ Ø§Ù„ÙØªØ­", canvas.width / 2, canvas.height / 2);

                        res(canvas.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        }

        document.getElementById('propForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const files = document.getElementById('f_imgs').files;
            let imgList = [];
            for (let f of files) imgList.push(await compressImg(f));

            const data = {
                type: document.getElementById('f_type').value,
                neigh: document.getElementById('f_neigh').value,
                area: document.getElementById('f_area').value,
                price: Number(document.getElementById('f_price').value),
                status: document.getElementById('f_status').value,
                map: document.getElementById('f_map').value,
                ownerName: document.getElementById('f_owner').value,
                ownerPhone: document.getElementById('f_phone').value,
                date: new Date().toLocaleDateString('ar-SA'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            if(!id) data.views = 0; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ù„Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            if(imgList.length > 0) data.imgs = imgList;

            if(id) await db.collection('properties').doc(id).update(data);
            else await db.collection('properties').add(data);
            
            document.getElementById('propForm').reset();
            document.getElementById('editId').value = '';
            loadData();
        };

        function filterContent() {
            const v = document.getElementById('searchBox').value.toLowerCase();
            const stat = document.getElementById('filterStatus').value;
            const filtered = allData.filter(i => 
                (i.neigh.toLowerCase().includes(v) || i.type.toLowerCase().includes(v)) &&
                (stat === 'Ø§Ù„ÙƒÙ„' || i.status === stat)
            );
            renderAll(filtered);
        }

        function exportFullBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", "Full_Backup_Alfateh_" + new Date().toISOString().slice(0,10) + ".json");
            dl.click();
        }

        function editItem(id) { /* Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ */ 
            const item = allData.find(i => i.id === id);
            document.getElementById('editId').value = item.id;
            document.getElementById('f_type').value = item.type;
            document.getElementById('f_neigh').value = item.neigh;
            document.getElementById('f_area').value = item.area;
            document.getElementById('f_price').value = item.price;
            document.getElementById('f_status').value = item.status;
            document.getElementById('f_map').value = item.map || '';
            document.getElementById('f_owner').value = item.ownerName || '';
            document.getElementById('f_phone').value = item.ownerPhone || '';
            window.scrollTo(0,0);
        }
        async function deleteItem(id) { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) { await db.collection('properties').doc(id).delete(); loadData(); } }
        function shareMe(t, n) { 
            const url = window.location.href;
            if(navigator.share) navigator.share({title: t, text: `Ø¹Ù‚Ø§Ø± ÙÙŠ Ø­ÙŠ ${n}`, url: url});
            else alert("Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡: " + url);
        }
        function cancelEdit() { document.getElementById('propForm').reset(); document.getElementById('editId').value=''; }

        loadData();
    </script>
</body>
</html>
