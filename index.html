<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙƒØªØ¨ Ø­ÙŠ Ø§Ù„ÙØªØ­ Ù„Ù„Ø¹Ù‚Ø§Ø±</title>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #113f28; --secondary: #d4af37; --bg: #f4f6f9; --card-bg: #ffffff;
            --text: #333; --border: #ddd; --shadow: rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --primary: #1a5c3a; --secondary: #f1c40f; --bg: #121212; --card-bg: #1e1e1e;
            --text: #e0e0e0; --border: #333; --shadow: rgba(0,0,0,0.5);
        }
        body { font-family: 'Almarai', sans-serif; margin: 0; background-color: var(--bg); color: var(--text); transition: 0.3s; padding-bottom: 50px; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { background: linear-gradient(135deg, var(--primary), #0a291a); color: white; padding: 30px 20px; position: relative; text-align: center; border-bottom: 4px solid var(--secondary); }
        .header-content { display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 20px; }
        .logo { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--secondary); object-fit: cover; background: white; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .top-nav { position: absolute; top: 10px; left: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .nav-btn { background: rgba(255,255,255,0.15); border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-family: 'Almarai'; font-size: 12px; transition: 0.3s; }
        .nav-btn:hover { background: var(--secondary); color: black; }

        .container { width: 95%; max-width: 1200px; margin: 20px auto; }
        
        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-bar { display: none; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 4px 10px var(--shadow); border: 1px solid var(--border); }
        .stat-card h4 { margin: 0; font-size: 12px; opacity: 0.8; }
        .stat-card span { font-size: 20px; font-weight: 800; color: var(--secondary); }

        /* Ø§Ù„ÙÙ„Ø§ØªØ± */
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
        .search-box { flex: 1; min-width: 250px; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); font-family: 'Almarai'; }
        .filter-select { padding: 12px; border-radius: 10px; background: var(--card-bg); color: var(--text); border: 1px solid var(--border); font-family: 'Almarai'; }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø±Ø¶ (ÙƒØ±ÙˆØª/Ù‚Ø§Ø¦Ù…Ø©) */
        .view-switcher { display: flex; gap: 5px; }
        .view-btn { padding: 10px; background: var(--card-bg); border: 1px solid var(--border); cursor: pointer; border-radius: 8px; color: var(--text); }
        .view-btn.active { background: var(--primary); color: white; }

        /* Ø§Ù„ÙƒØ±ÙˆØª */
        .properties-container { display: grid; gap: 20px; transition: 0.3s; }
        .grid-view { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
        .list-view { grid-template-columns: 1fr; }

        .prop-card { background: var(--card-bg); border-radius: 15px; overflow: hidden; box-shadow: 0 6px 15px var(--shadow); border: 1px solid var(--border); position: relative; transition: 0.3s; }
        .prop-card:hover { transform: translateY(-5px); }
        .prop-img { width: 100%; height: 200px; object-fit: cover; }
        .status-badge { position: absolute; top: 10px; right: 10px; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; color: white; z-index: 5; }
        .status-available { background: #27ae60; }
        .status-sold { background: #c0392b; }
        .status-archived { background: #7f8c8d; }

        .prop-info { padding: 15px; }
        .prop-price { font-size: 20px; font-weight: 800; color: var(--secondary); margin: 5px 0; }
        .prop-tags { display: flex; gap: 10px; font-size: 12px; opacity: 0.8; margin-bottom: 10px; }
        
        .card-actions { display: flex; gap: 8px; margin-top: 10px; }
        .action-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Almarai'; font-weight: bold; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .btn-details { background: var(--primary); color: white; }
        .btn-share { background: #eef2f0; color: #113f28; border: 1px solid #ddd; }
        
        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ù†Ø§ÙØ°Ø©) */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); overflow-y: auto; }
        .modal-content { background: var(--card-bg); margin: 2% auto; width: 90%; max-width: 700px; border-radius: 20px; padding: 25px; position: relative; }
        .close { position: absolute; left: 20px; top: 15px; font-size: 30px; cursor: pointer; }

        /* Ø²Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ */
        .wa-float { position: fixed; bottom: 20px; right: 20px; background: #25d366; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; transition: 0.3s; }
        .wa-float:hover { transform: scale(1.1); }

        #adminPanel { display: none; background: #faf8f0; border: 2px dashed var(--secondary); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        [data-theme="dark"] #adminPanel { background: #1a1a1a; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body data-theme="light">

    <div id="loading"><b>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</b></div>

    <header>
        <div class="top-nav">
            <button class="nav-btn" onclick="toggleTheme()">ğŸŒ™ ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ</button>
            <button class="nav-btn" onclick="goHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button class="nav-btn map-btn" onclick="window.open('https://maps.google.com/?q=Ø­ÙŠ+Ø§Ù„ÙØªØ­')">ğŸ“ Ù…ÙˆÙ‚Ø¹Ù†Ø§</button>
            <button class="nav-btn" onclick="toggleAdmin()" id="adminLock">ğŸ‘¤ Ø¯Ø®ÙˆÙ„</button>
        </div>
        
        <div class="header-content">
            <img src="https://c.top4top.io/p_37048y9xn1.jpg" class="logo" alt="Logo">
            <div>
                <h1 style="margin:0">Ø­ÙŠ Ø§Ù„ÙØªØ­ Ù„Ù„Ø¹Ù‚Ø§Ø±</h1>
                <p style="margin:5px 0 0; opacity:0.8">Ù…ØµØ¯Ø§Ù‚ÙŠØ© ÙÙŠ Ø§Ù„ØªØ¹Ø§Ù…Ù„.. Ø¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="adminPanel">
            <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙƒØªØ¨</h3>
            <div class="stats-bar" id="statsBar">
                <div class="stat-card"><h4>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h4><span id="statTotal">0</span></div>
                <div class="stat-card"><h4>Ø§Ù„Ù…ØªÙˆÙØ±</h4><span id="statAvail">0</span></div>
                <div class="stat-card"><h4>Ø§Ù„Ù…Ø¨Ø§Ø¹</h4><span id="statSold">0</span></div>
            </div>
            <form id="propForm">
                <input type="hidden" id="editId">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px;">
                    <input type="text" id="f_type" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± (ÙÙŠÙ„Ø§ØŒ Ø´Ù‚Ø©..)" required class="search-box">
                    <input type="text" id="f_neigh" placeholder="Ø§Ù„Ø­ÙŠ" required class="search-box">
                    <input type="text" id="f_area" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø©" class="search-box">
                    <input type="number" id="f_price" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)" required class="search-box">
                    <select id="f_status" class="filter-select">
                        <option value="Ù…ØªØ§Ø­">Ù…ØªØ§Ø­</option>
                        <option value="Ù…Ø¨Ø§Ø¹">Ù…Ø¨Ø§Ø¹</option>
                        <option value="Ù…Ø­Ø¬ÙˆØ²">Ù…Ø­Ø¬ÙˆØ²</option>
                    </select>
                    <input type="text" id="f_map" placeholder="Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="search-box">
                    <input type="text" id="f_ownerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø®Ø§Øµ)" class="search-box" style="background:#fffde7">
                    <input type="text" id="f_ownerPhone" placeholder="Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø®Ø§Øµ)" class="search-box" style="background:#fffde7">
                    <input type="file" id="f_imgs" multiple accept="image/*" class="search-box">
                </div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button type="submit" style="background:var(--primary); color:white; flex:2; padding:15px; border-radius:10px; cursor:pointer; font-weight:bold;">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø§Ø±</button>
                    <button type="button" onclick="backupData()" style="background:#007bff; color:white; flex:1; border-radius:10px; cursor:pointer;">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Excel</button>
                    <button type="button" onclick="cancelEdit()" style="background:#666; color:white; flex:1; border-radius:10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>

        <div class="toolbar">
            <input type="text" id="searchInp" class="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø­ÙŠ Ø£Ùˆ Ù†ÙˆØ¹ Ø¹Ù‚Ø§Ø±..." onkeyup="filterData()">
            <select id="filterType" class="filter-select" onchange="filterData()">
                <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                <option value="ÙÙŠÙ„Ø§">ÙÙ„Ù„</option>
                <option value="Ø´Ù‚Ø©">Ø´Ù‚Ù‚</option>
                <option value="Ø£Ø±Ø¶">Ø£Ø±Ø§Ø¶ÙŠ</option>
                <option value="Ø¯ÙˆØ¨Ù„ÙƒØ³">Ø¯ÙˆØ¨Ù„ÙƒØ³Ø§Øª</option>
            </select>
            <div class="view-switcher">
                <button class="view-btn active" id="gridBtn" onclick="setView('grid')">â¬œ ÙƒØ±ÙˆØª</button>
                <button class="view-btn" id="listBtn" onclick="setView('list')">â˜° Ù‚Ø§Ø¦Ù…Ø©</button>
            </div>
        </div>

        <div id="propGrid" class="properties-container grid-view"></div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <a href="https://wa.me/966590002216" class="wa-float" target="_blank">
        <svg style="width:35px;height:35px;fill:white" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.888-.788-1.489-1.761-1.663-2.06-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51a12.8 12.8 0 0 0-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.82 9.82 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413Z"/></svg>
    </a>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAbzqda0NFaj3nAotHK9_1exNqNDeRASxk",
            authDomain: "alfateh-aqar.firebaseapp.com",
            projectId: "alfateh-aqar",
            storageBucket: "alfateh-aqar.firebasestorage.app",
            messagingSenderId: "170214550520",
            appId: "1:170214550520:web:638dfbc62ea5edc7cc040d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let isAdmin = false;
        let allData = [];

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø¹Ø±
        function formatPrice(num) {
            return Number(num).toLocaleString('en-US') + " Ø±ÙŠØ§Ù„";
        }

        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            const target = current === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', target);
        }

        function setView(type) {
            const grid = document.getElementById('propGrid');
            if(type === 'grid') {
                grid.className = 'properties-container grid-view';
                document.getElementById('gridBtn').classList.add('active');
                document.getElementById('listBtn').classList.remove('active');
            } else {
                grid.className = 'properties-container list-view';
                document.getElementById('listBtn').classList.add('active');
                document.getElementById('gridBtn').classList.remove('active');
            }
        }

        function toggleAdmin() {
            if (!isAdmin && prompt("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:") === "123") {
                isAdmin = true;
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('statsBar').style.display = 'grid';
                document.getElementById('adminLock').innerText = "ğŸ‘¤ Ø®Ø±ÙˆØ¬";
            } else {
                isAdmin = false;
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('statsBar').style.display = 'none';
                document.getElementById('adminLock').innerText = "ğŸ‘¤ Ø¯Ø®ÙˆÙ„";
            }
            renderData(allData);
        }

        async function loadData() {
            document.getElementById('loading').style.display = 'flex';
            const snapshot = await db.collection('properties').orderBy('timestamp', 'desc').get();
            allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateStats();
            renderData(allData);
            document.getElementById('loading').style.display = 'none';
        }

        function updateStats() {
            document.getElementById('statTotal').innerText = allData.length;
            document.getElementById('statAvail').innerText = allData.filter(i => i.status === 'Ù…ØªØ§Ø­').length;
            document.getElementById('statSold').innerText = allData.filter(i => i.status === 'Ù…Ø¨Ø§Ø¹').length;
        }

        function renderData(data) {
            const container = document.getElementById('propGrid');
            container.innerHTML = '';
            data.forEach(item => {
                if (item.status === 'Ù…Ø¤Ø±Ø´Ù' && !isAdmin) return;

                const card = document.createElement('div');
                card.className = 'prop-card';
                const statusCls = item.status === 'Ù…ØªØ§Ø­' ? 'status-available' : (item.status === 'Ù…Ø¨Ø§Ø¹' ? 'status-sold' : 'status-archived');
                
                card.innerHTML = `
                    <div class="status-badge ${statusCls}">${item.status}</div>
                    <img src="${(item.imgs && item.imgs[0]) || 'https://via.placeholder.com/400x200?text=No+Image'}" class="prop-img">
                    <div class="prop-info">
                        <div class="prop-tags"><span>ğŸ“ ${item.neigh}</span> <span>ğŸ  ${item.type}</span></div>
                        <div class="prop-price">${formatPrice(item.price)}</div>
                        <div style="font-size:13px; margin-bottom:10px;">Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${item.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}</div>
                        <div class="card-actions">
                            <button class="action-btn btn-details" onclick="openDetails('${item.id}')">ğŸ‘ï¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                            <button class="action-btn btn-share" onclick="shareProperty('${item.type}', '${item.neigh}')">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
                        </div>
                        ${isAdmin ? `
                            <div class="card-actions" style="margin-top:5px; border-top:1px solid var(--border); padding-top:5px;">
                                <button onclick="editItem('${item.id}')" style="font-size:10px;">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button onclick="updateStatus('${item.id}', 'Ù…Ø¨Ø§Ø¹')" style="font-size:10px; background:#c0392b; color:white;">Ù…Ø¨Ø§Ø¹</button>
                                <button onclick="updateStatus('${item.id}', 'Ù…Ø¤Ø±Ø´Ù')" style="font-size:10px; background:#7f8c8d; color:white;">Ø£Ø±Ø´ÙØ©</button>
                                <button onclick="deleteItem('${item.id}')" style="font-size:10px; background:black; color:white;">Ø­Ø°Ù</button>
                            </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function filterData() {
            const s = document.getElementById('searchInp').value.toLowerCase();
            const t = document.getElementById('filterType').value;
            const filtered = allData.filter(item => {
                const matchSearch = item.neigh.includes(s) || item.type.includes(s);
                const matchType = t === "" || item.type.includes(t);
                return matchSearch && matchType;
            });
            renderData(filtered);
        }

        async function openDetails(id) {
            const item = allData.find(i => i.id === id);
            let imgsHtml = '<div style="display:flex; overflow-x:auto; gap:10px; margin-bottom:15px;">';
            (item.imgs || []).forEach(src => imgsHtml += `<img src="${src}" style="height:200px; border-radius:10px;">`);
            imgsHtml += '</div>';

            document.getElementById('modalBody').innerHTML = `
                ${imgsHtml}
                <h2 style="color:var(--primary)">${item.type} - Ø­ÙŠ ${item.neigh}</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; border-top:1px solid #ddd; padding-top:15px;">
                    <p><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${formatPrice(item.price)}</p>
                    <p><b>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</b> ${item.area}</p>
                    <p><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${item.status}</p>
                    <p><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${item.date}</p>
                </div>
                ${isAdmin ? `<div style="background:#fffde7; padding:10px; border-radius:10px; margin:10px 0;">
                    <p><b>Ø§Ù„Ù…Ø§Ù„Ùƒ:</b> ${item.ownerName}</p>
                    <p><b>Ø§Ù„Ø¬ÙˆØ§Ù„:</b> ${item.ownerPhone}</p>
                </div>` : ''}
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <a href="https://wa.me/966590002216?text=Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† ${item.type} ÙÙŠ ${item.neigh}" target="_blank" style="flex:1; background:#25d366; color:white; text-align:center; padding:15px; border-radius:10px; text-decoration:none; font-weight:bold;">ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</a>
                    ${item.map ? `<a href="${item.map}" target="_blank" style="flex:1; background:#4285F4; color:white; text-align:center; padding:15px; border-radius:10px; text-decoration:none; font-weight:bold;">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>` : ''}
                </div>
            `;
            document.getElementById('detailsModal').style.display = 'block';
        }

        function shareProperty(type, neigh) {
            const text = `Ø´ÙˆÙ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ù…ÙƒØªØ¨ Ø­ÙŠ Ø§Ù„ÙØªØ­: ${type} ÙÙŠ Ø­ÙŠ ${neigh}`;
            if (navigator.share) {
                navigator.share({ title: 'Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯', text: text, url: window.location.href });
            } else {
                alert("Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡: " + window.location.href);
            }
        }

        async function updateStatus(id, newStatus) {
            if(confirm(`ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ${newStatus}ØŸ`)) {
                await db.collection('properties').doc(id).update({ status: newStatus });
                loadData();
            }
        }

        async function deleteItem(id) {
            if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!")) {
                await db.collection('properties').doc(id).delete();
                loadData();
            }
        }

        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "alfateh_backup_" + new Date().toLocaleDateString() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // Ø¶ØºØ· Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙ‚Ø©
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxW = 800;
                        const scale = maxW / img.width;
                        canvas.width = maxW;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        }

        document.getElementById('propForm').onsubmit = async (e) => {
            e.preventDefault();
            document.getElementById('loading').style.display = 'flex';
            const id = document.getElementById('editId').value;
            const files = document.getElementById('f_imgs').files;
            let imgList = [];
            for (let f of files) { imgList.push(await compressImage(f)); }

            const data = {
                type: document.getElementById('f_type').value,
                neigh: document.getElementById('f_neigh').value,
                area: document.getElementById('f_area').value,
                price: document.getElementById('f_price').value,
                status: document.getElementById('f_status').value,
                map: document.getElementById('f_map').value,
                ownerName: document.getElementById('f_ownerName').value,
                ownerPhone: document.getElementById('f_ownerPhone').value,
                date: new Date().toLocaleDateString('ar-SA'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            if(imgList.length > 0) data.imgs = imgList;

            if(id) await db.collection('properties').doc(id).update(data);
            else await db.collection('properties').add(data);
            
            document.getElementById('propForm').reset();
            document.getElementById('editId').value = "";
            loadData();
        };

        function editItem(id) {
            const item = allData.find(i => i.id === id);
            document.getElementById('editId').value = item.id;
            document.getElementById('f_type').value = item.type;
            document.getElementById('f_neigh').value = item.neigh;
            document.getElementById('f_area').value = item.area;
            document.getElementById('f_price').value = item.price;
            document.getElementById('f_status').value = item.status;
            document.getElementById('f_map').value = item.map || "";
            document.getElementById('f_ownerName').value = item.ownerName;
            document.getElementById('f_ownerPhone').value = item.ownerPhone;
            window.scrollTo(0,0);
        }

        function closeModal() { document.getElementById('detailsModal').style.display = 'none'; }
        function goHome() { window.location.reload(); }
        function cancelEdit() { document.getElementById('propForm').reset(); document.getElementById('editId').value = ""; }

        loadData();
    </script>
</body>
</html>
